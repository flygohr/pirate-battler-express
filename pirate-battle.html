<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Pirate Battle</title>
</head>
<body>
<p>
    <label for="pirateIdOne">Pirate One Objkt ID</label>
    <input id="pirateIdOne" value="50761">
</p>
<p>
    <label for="pirateIdTwo">Pirate Two Objkt ID</label>
    <input id="pirateIdTwo" value="198714">
</p>
<p>
    <button id="fightButton">Fight</button>
</p>
<div id="logView"></div>
<script>
    const pirateIdOne = document.getElementById('pirateIdOne');
    const pirateIdTwo = document.getElementById('pirateIdTwo');
    const fightButton = document.getElementById('fightButton');
    const logView = document.getElementById('logView');
    const missedMessages = [
        'Nearly took his own eye out',
        'Swung aimlessly in the air',
        'Couldn\'t hit a barn doorâ€¦',
    ];
    let interval;

    function handleMissed(logEntry) {
        return logEntry.message + ' ' + missedMessages[~~(Math.random() * missedMessages.length)];
    }

    fightButton.onclick = async() => {
        if(interval) clearInterval(interval);
        if(!(pirateIdOne.value && pirateIdTwo.value)) {
            alert('Please enter the objkt ids for both pirates');
            return;
        }
        if(!(/\d+/.test(pirateIdOne.value) && /\d+/.test(pirateIdTwo.value))) {
            alert('Objkt ids must be numbers');
            return;
        }
        const response = await fetch(
            `https://pirate-battler-express.orderandchaos.repl.co/fight?pirates=${pirateIdOne.value},${pirateIdTwo.value}`);
        const battleLog = await response.json();
        let i = 0;
        interval = setInterval(() => {
            const logEntry = battleLog[i];
            switch(logEntry.type) {
                case 'pirate-one-stats':
                case 'pirate-two-stats':
                    logView.innerHTML = '';
                    logView.appendChild(handleStats(logEntry));
                    break;
                case 'initiative-roll':
                    logView.innerText = handleInitiative(logEntry);
                    break;
                case 'attack-roll':
                    logView.innerText = handleAttackRoll(logEntry);
                    break;
                case 'dodge-roll':
                    logView.innerText = handleDodgeRoll(logEntry);
                    break;
                case 'missed':
                    logView.innerText = handleMissed(logEntry);
                    break;
                default:
                    logView.innerText = logEntry.message;
            }
            i++;
            if(i === battleLog.length) clearInterval(interval);
        }, 2000);

    };

    function handleStats(logEntry) {
        const div = document.createElement('div');
        const title = document.createElement('h3');
        const ul = document.createElement('ul');
        const id = document.createElement('li');
        id.innerText = `Objkt ID: ${logEntry.id}`;
        const name = document.createElement('li');
        name.innerText = `Name: ${logEntry.name}`;
        const damage = document.createElement('li');
        damage.innerText = `Damage: ${logEntry.damage}`;
        const hitChance = document.createElement('li');
        hitChance.innerText = 'Hit Chance: ' + logEntry.hitChance;
        const health = document.createElement('li');
        health.innerText = `Health: ${logEntry.health}`;
        const initiative = document.createElement('li');
        initiative.innerText = `Initiative: ${logEntry.initiative}`;
        const dodgeChance = document.createElement('li');
        dodgeChance.innerText = `Dodge Chance: ${logEntry.dodgeChance}`;
        div.appendChild(ul);
        div.appendChild(title);
        ul.appendChild(name);
        ul.appendChild(id);
        ul.appendChild(health);
        ul.appendChild(initiative);
        ul.appendChild(hitChance);
        ul.appendChild(damage);
        ul.appendChild(dodgeChance);
        return ul;
    }

    function handleInitiative(logEntry) {
        return logEntry.message;
    }

    function handleAttackRoll({message, required, roll}) {
        const result = roll >= required ? 'Success' : 'Failure';
        return `${message} Attack Roll: ${roll} Required: ${required}, ${result}`;
    }

    function handleDodgeRoll({message, required, roll}) {
        const result = roll >= required ? 'Success' : 'Failure';
        return `${message} Dodge Roll: ${roll} Required: ${required}, ${result}`;
    }

</script>
</body>
</html>
